---
vignette: >
  % \VignetteIndexEntry{BugSigDB Stats and Analysis}
  % \VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
date: '`r format(Sys.Date(), "%B %e, %Y")`'
output:
  html_document:
    mathjax: null   
---

# Setup
```{r setup, message=FALSE, warning=FALSE}
library(bugsigdbr)
library(BugSigDBStats)
library(ggpubr)
```

# Reading data

Get bulk export from bugsigdb.org:

```{r curationFile}
full.dat <- bugsigdbr::importBugSigDB()
dim(full.dat)
colnames(full.dat)
```

Stripping illformed entries:

```{r}
is.study <- grepl("^Study [0-9]+$", full.dat[["Study"]])
is.exp <- grepl("^Experiment [0-9]+$", full.dat[["Experiment"]])
full.dat <- full.dat[is.study & is.exp, ]
```

# Curation output

Number of papers and signatures curated:

```{r nrPapers}
pmids <- unique(full.dat[,"PMID"])
length(pmids)
nrow(full.dat)
```

Publication date of the curated papers:

```{r pubDate}
pmids <- pmids[!is.na(pmids)]
pubyear1 <- pmid2pubyear(pmids[1:361])
pubyear2 <- pmid2pubyear(pmids[362:length(pmids)])
pubyear <- c(pubyear1, pubyear2)
head(cbind(pmids, pubyear))
```

```{r pubDate2}
tab <- table(pubyear)
tab <- tab[-length(tab)]
tab <- tab[order(as.integer(names(tab)))]
df <- data.frame(year = names(tab), papers = as.integer(tab))
ggbarplot(df, x = "year", y = "papers", 
          label = TRUE, fill = "steelblue",
          ggtheme = theme_bw())
``` 

Stripping empty signatures:

```{r} 
ind1 <- lengths(full.dat[["MetaPhlAn taxon names"]]) > 0
ind2 <- lengths(full.dat[["NCBI Taxonomy IDs"]]) > 0
dat <- full.dat[ind1 & ind2,]
nrow(dat)
```

Papers containing only empty UP and DOWN signatures (under curation?):
```{r}
setdiff(pmids, unique(dat[,"PMID"]))
```

Progress over time:
```{r, fig.width=10, fig.height=10}
dat[,"Curated date"] <- as.character(lubridate::dmy(dat[,"Curated date"]))
plotProgressOverTime(dat)
plotProgressOverTime(dat, diff = TRUE)
```

Stratified by curator:
```{r curatorOutput, fig.width=10, fig.height=10}
npc <- stratifyByCurator(dat)
plotCuratorStats(dat, npc)
```

Number of complete and revised signatures:
```{r}
table(df[["State"]])
table(dat[,"Revision editor"])
```

# Study stats

## Study design

```{r}
spl <- split(dat[["Study"]], dat[["Study design"]])
sds <- lapply(spl, unique)
sort(lengths(sds), decreasing = FALSE)
```

# Experiment stats

Columns of the full dataset that describe experiments:

```{r}
# Experiment ID
exp.cols <- c("Study", "Experiment")

# Subjects
sub.cols <- c("Host species",    
              "Location of subjects", 
              "Body site",
              "Condition", 
              "Antibiotics exclusion",
              "Group 0 sample size",
              "Group 1 sample size")

# Lab analysis              
lab.cols <-  c("Sequencing type",
              "16S variable region",
              "Sequencing platform")

# Statistical analysis
stat.cols <-  c("Statistical test",
              "MHT correction",
              "Significance threshold")

# Alpha diversity
div.cols <- c("Pielou",
              "Shannon",
              "Chao1",
              "Simpson", 
              "Inverse Simpson",
              "Richness")
```

Restrict dataset to experiment information:

```{r}
exps <- dat[,c(exp.cols, sub.cols, lab.cols, stat.cols, div.cols)]
exps <- unique(exps)
```

## Subjects

Number of experiments for the top 10 categories for each subjects column:

```{r}
sub.tab <- lapply(sub.cols[1:5], tabCol, df = exps, n = 10)
names(sub.tab) <- sub.cols[1:5]
sub.tab
```

Proportions instead:

```{r}
sub.tab <- lapply(sub.cols[1:5], tabCol, df = exps, n = 10, perc = TRUE)
names(sub.tab) <- sub.cols[1:5]
sub.tab
```

Sample size:

```{r}
ssize <- apply(exps[,sub.cols[6:7]], 2, summary)
ssize
```

## Lab analysis

Number of experiments for the top 10 categories for each lab analysis column:

```{r}
lab.tab <- lapply(lab.cols, tabCol, df = exps, n = 10)
names(lab.tab) <- lab.cols
lab.tab
```

Proportions instead:

```{r}
lab.tab <- lapply(lab.cols, tabCol, df = exps, n = 10, perc = TRUE)
names(lab.tab) <- lab.cols
lab.tab
```

## Statistical analysis

Number of experiments for the top 10 categories for each statistical analysis column:

```{r}
stat.tab <- lapply(stat.cols, tabCol, df = exps, n = 10)
names(stat.tab) <- stat.cols
stat.tab
```

Proportions instead:

```{r}
stat.tab <- lapply(stat.cols, tabCol, df = exps, n = 10, perc = TRUE)
names(stat.tab) <- stat.cols
stat.tab
```

## Alpha diversity

Overall distribution:

```{r}
apply(exps[,div.cols], 2, table)
```

Correspondence of Shannon diversity and Richness:

```{r}
table(exps$Shannon, exps$Richness)
```

Conditions with consistently increased or decreased alpha diversity:

```{r}
tabDiv(exps, "Shannon", "Condition")
tabDiv(exps, "Shannon", "Condition", perc = TRUE)
tabDiv(exps, "Richness", "Condition")
tabDiv(exps, "Richness", "Condition", perc = TRUE)
```

Body sites with consistently increased or decreased alpha diversity:

```{r}
tabDiv(exps, "Shannon", "Body site")
tabDiv(exps, "Shannon", "Body site", perc = TRUE)
tabDiv(exps, "Richness", "Body site")
tabDiv(exps, "Richness", "Body site", perc = TRUE)
```

# Signature stats

```{r}
sigs <- bugsigdbr::getSignatures(dat, tax.id.type = "metaphlan")
```

## Unique microbes

Number unique microbes contained in the signatures:
```{r ubugs}
(nuniq <- length(unique(unlist(sigs))))
```

Development of unique microbes captured over time:
```{r}
plotUniqueMicrobesOverTime(dat)
```

## Microbe set size distribution

```{r setSize}
summary(lengths(sigs))
gghistogram(lengths(sigs), bins = 30, ylab = "number of signatures",
    xlab = "signature size", fill = "#00AFBB", ggtheme = theme_bw())
sum(lengths(sigs) > 4)
```

## Signature similarity

### Jaccard index

The `calcPairwiseOverlaps` function works quickly on all of bugsigdb currently, 
but `makeDist` is slow and surely could be improved for efficiency. For now,
use only nasal samples:

```{r}
dat_subset <- subset(dat, `Body site` == "stomach")
sigs_subset <- bugsigdbr::getSignatures(dat_subset)
paircomp <- calcPairwiseOverlaps(sigs_subset)
jdist <- makeDist(paircomp, "jaccard")
```

Create a dendrogram of Jaccard dissimilarities (1.0 has no overlap, 0.0 are identical signatures). 

```{r, fig.height=15, fig.width=8}
plot(hclust(jdist))
```


